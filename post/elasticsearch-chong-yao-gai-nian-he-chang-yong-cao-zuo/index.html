<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ElasticSearch重要概念和常用操作 | Gridea</title>
<link rel="shortcut icon" href="https://kelvin-qin.github.io//favicon.ico?v=1641536563826">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://kelvin-qin.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="ElasticSearch重要概念和常用操作 | Gridea - Atom Feed" href="https://kelvin-qin.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="最基础的增删改查
在ElasticSearh 7.3版本全部验证过。
创建索引
PUT index_test

写入数据
POST index_test/_doc
{
    &quot;title&quot;:&quot;oppo&quo..." />
    <meta name="keywords" content="ElasticSearch,BigData,点线面" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://kelvin-qin.github.io/">
  <img class="avatar" src="https://kelvin-qin.github.io//images/avatar.png?v=1641536563826" alt="">
  </a>
  <h1 class="site-title">
    Gridea
  </h1>
  <p class="site-description">
    温故而知新
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          首页
        </a>
      
    
      
        <a href="/archives" class="menu">
          归档
        </a>
      
    
      
        <a href="/tags" class="menu">
          标签
        </a>
      
    
      
        <a href="/post/about" class="menu">
          关于
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              ElasticSearch重要概念和常用操作
            </h2>
            <div class="post-info">
              <span>
                2022-01-05
              </span>
              <span>
                4 min read
              </span>
              
                <a href="https://kelvin-qin.github.io/tag/MM38RISoP/" class="post-tag">
                  # ElasticSearch
                </a>
              
                <a href="https://kelvin-qin.github.io/tag/VxLm5JEIfr/" class="post-tag">
                  # BigData
                </a>
              
                <a href="https://kelvin-qin.github.io/tag/Qb7zsbarJN/" class="post-tag">
                  # 点线面
                </a>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="最基础的增删改查">最基础的增删改查</h1>
<p>在ElasticSearh 7.3版本全部验证过。</p>
<h2 id="创建索引">创建索引</h2>
<pre><code>PUT index_test
</code></pre>
<h2 id="写入数据">写入数据</h2>
<pre><code>POST index_test/_doc
{
    &quot;title&quot;:&quot;oppo&quot;,
    &quot;price&quot;:1999
}
</code></pre>
<h2 id="查询数据">查询数据</h2>
<pre><code># 统计索引的记录条数
GET index_test/_count
# 查询前5条数据
GET index_test/_search
{
    &quot;size&quot;:5,
    &quot;query&quot;:{
        &quot;match_all&quot;:{}
    }
}
</code></pre>
<h2 id="删除数据">删除数据</h2>
<pre><code># A：删除1条确定的数据
# 以下示例中的1是一个文档的id，通过上述查询可以看到。 
DELETE /&lt;index&gt;/_doc/&lt;_id&gt;
DELETE /index_test/_doc/1

# B：删除批量数据，通过查询删除，Delete by query API
# POST /&lt;index&gt;/_delete_by_query
# 例如删除某索引全部数据
POST twitter/_delete_by_query?conflicts=proceed
{
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  }
}
# 删除年龄大于10的数据
POST twitter/_delete_by_query?routing=1
{
  &quot;query&quot;: {
    &quot;range&quot; : {
        &quot;age&quot; : {
           &quot;gte&quot; : 10
        }
    }
  }
}
</code></pre>
<p>批量删除的默认滚动批大小是1000，可以调整。</p>
<pre><code>POST twitter/_delete_by_query?scroll_size=5000
{
  &quot;query&quot;: {
    &quot;term&quot;: {
      &quot;user&quot;: &quot;kimchy&quot;
    }
  }
}
</code></pre>
<h2 id="删除整个索引">删除整个索引</h2>
<p>与上述删除索引中的全部数据不同，还可以直接删除索引，拆家了这是。</p>
<pre><code># 删除index_test这个索引，逗号分隔多个索引
DELETE /index_test
</code></pre>
<h1 id="索引开关">索引开/关</h1>
<pre><code># 某些操作需要关闭索引再进行；或者关闭一些暂时不用的索引。
POST index_test/_close
POST index_test/_open
</code></pre>
<h1 id="集群运维重要操作">集群运维重要操作</h1>
<h2 id="节点掉线后延迟分配">节点掉线后延迟分配</h2>
<p>这个参数对于稳定ES在线集群相当重要，<strong>这个操作不影响副本分片提升为主分片。</strong><br>
节点离线后不会立即进行分片平衡，默认值是1m，节点离线后先等待这么久再进行副本分片分配和迁移等操作，以免频繁进行数据迁移耗费过大。</p>
<pre><code>PUT _all/_settings
{
  &quot;settings&quot;: {
    &quot;index.unassigned.node_left.delayed_timeout&quot;: &quot;5m&quot;
  }
}
# 对应的curl命令如下
curl -X PUT &quot;localhost:9200/_all/_settings?pretty&quot; -H 'Content-Type: application/json' -d'
{
  &quot;settings&quot;: {
    &quot;index.unassigned.node_left.delayed_timeout&quot;: &quot;5m&quot;
  }
}
'
# 但如果一个节点确实是（永远）下线了，可以指示立即分配：
curl -X PUT &quot;localhost:9200/_all/_settings?pretty&quot; -H 'Content-Type: application/json' -d'
{
  &quot;settings&quot;: {
    &quot;index.unassigned.node_left.delayed_timeout&quot;: &quot;0&quot;
  }
}
'
</code></pre>
<h2 id="开启关闭集群的自动分配shard-allocation">开启关闭集群的自动分配(shard allocation)</h2>
<p>这个在ES集群大范围重启前要考虑（滚动重启也算），<strong>维护时可以先停止分配，等维护好后再开启分配</strong>（强烈建议）。</p>
<pre><code># 客户端停写，关闭集群shard allocation
PUT _cluster/settings
{
    &quot;persistent&quot;: {
        &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;
    }
}
# 执行同步刷新
POST _flush/synced
# 停止和重启ES服务后，重新开启集群shard allocation
PUT _cluster/settings
{
    &quot;persistent&quot;: {
        &quot;cluster.routing.allocation.enable&quot;: &quot;all&quot;
    }
} 
</code></pre>
<h2 id="查看es集群的配置">查看ES集群的配置</h2>
<p>查看配置以验证上述更改是否已经生效了。（<strong>多层json格式</strong>）</p>
<pre><code>GET _cluser/settings
</code></pre>
<h1 id="集群运维排错基本步骤">集群运维排错基本步骤</h1>
<ol>
<li>查看集群健康状态<br>
重点是<code>red</code>还是<code>yellow</code>，未分配个数，延迟分配个数，正在初始化的个数，节点数</li>
</ol>
<pre><code>curl -X GET &quot;localhost:9200/_cluster/health?pretty&quot;
</code></pre>
<ol start="2">
<li>如果节点数不正常，那么有ES实例失联或者宕机，需要优先启动该ES实例。</li>
<li>ES实例全部上线后，如果正在初始化个数为0，且有未分配的分片，则需要explain查看未分配原因，对症下药；如果有正在初始化的，等待恢复即可。</li>
<li>一般进行处理后，分片会自动进行分配；如果未分配，可以执行reroute命令：</li>
</ol>
<pre><code># 在报错原因里提示分配失败是因为达到最大分配次数时，可使用这个命令。
POST /_cluster/reroute?retry_failed=true&amp;pretty
</code></pre>
<ol start="5">
<li>重复2~4。</li>
</ol>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E6%9C%80%E5%9F%BA%E7%A1%80%E7%9A%84%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5">最基础的增删改查</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95">创建索引</a></li>
<li><a href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE">写入数据</a></li>
<li><a href="#%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE">查询数据</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE">删除数据</a></li>
<li><a href="#%E5%88%A0%E9%99%A4%E6%95%B4%E4%B8%AA%E7%B4%A2%E5%BC%95">删除整个索引</a></li>
</ul>
</li>
<li><a href="#%E7%B4%A2%E5%BC%95%E5%BC%80%E5%85%B3">索引开/关</a></li>
<li><a href="#%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4%E9%87%8D%E8%A6%81%E6%93%8D%E4%BD%9C">集群运维重要操作</a>
<ul>
<li><a href="#%E8%8A%82%E7%82%B9%E6%8E%89%E7%BA%BF%E5%90%8E%E5%BB%B6%E8%BF%9F%E5%88%86%E9%85%8D">节点掉线后延迟分配</a></li>
<li><a href="#%E5%BC%80%E5%90%AF%E5%85%B3%E9%97%AD%E9%9B%86%E7%BE%A4%E7%9A%84%E8%87%AA%E5%8A%A8%E5%88%86%E9%85%8Dshard-allocation">开启关闭集群的自动分配(shard allocation)</a></li>
<li><a href="#%E6%9F%A5%E7%9C%8Bes%E9%9B%86%E7%BE%A4%E7%9A%84%E9%85%8D%E7%BD%AE">查看ES集群的配置</a></li>
</ul>
</li>
<li><a href="#%E9%9B%86%E7%BE%A4%E8%BF%90%E7%BB%B4%E6%8E%92%E9%94%99%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4">集群运维排错基本步骤</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://kelvin-qin.github.io/post/hello-gridea/">
              <h3 class="post-title">
                Hello Gridea
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://kelvin-qin.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
